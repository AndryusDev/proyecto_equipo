{% extends 'panel_base.html' %}
{% load static %}
{% block titulo %}Gesti√≥n de Pedidos{% endblock %}

{% block contenido %}
<link rel="stylesheet" href="{% static 'css/pedidos_pro.css' %}">

<section class="pos-layout">
  <!-- ü™ë MESAS -->
  <aside class="col-mesas">
    <h2>ü™ë Mesas</h2>
    <div class="grid-mesas">
      {% for mesa in mesas %}
      <button
        type="button"
        class="mesa-card {% if mesa.ocupada %}ocupada{% else %}libre{% endif %}"
        data-id="{{ mesa.id }}"
        data-ocupada="{{ mesa.ocupada|yesno:'true,false' }}"
        onclick="seleccionarMesa(this)"
        {% if mesa.ocupada %}disabled{% endif %}>
        <span class="numero">#{{ mesa.numero }}</span>
        <span class="estado">
          {% if mesa.ocupada %}üü• Ocupada{% else %}üü© Libre{% endif %}
        </span>
      </button>
      {% endfor %}
    </div>
  </aside>

  <!-- üçΩÔ∏è MEN√ö -->
  <main class="col-menu">
    <h2>üçΩÔ∏è Men√∫</h2>
    {% for categoria in categorias %}
    <div class="categoria">
      <h3>{{ categoria.nombre }}</h3>
      <div class="platos-grid">
        {% for plato in categoria.platos.all %}
        {% if plato.disponible %}
        <div class="plato-card" onclick="agregarPlato('{{ plato.id }}', '{{ plato.nombre }}', '{{ plato.precio }}')">
          <div class="img-container">
            {% if plato.imagen %}
            <img src="{{ plato.imagen.url }}" alt="{{ plato.nombre }}">
            {% else %}
            <img src="{% static 'img/plato_default.jpg' %}" alt="Sin imagen">
            {% endif %}
          </div>
          <h4>{{ plato.nombre }}</h4>
          <p class="precio">${{ plato.precio }}</p>
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </main>

  <!-- üí∞ FACTURA / RESUMEN -->
  <aside class="col-resumen">
    <h2>üßæ Pedido</h2>
    <div class="mesa-activa" id="mesaActiva">
      <p><strong>Mesa:</strong> <span id="mesaNumero">Ninguna</span></p>
    </div>

    <ul id="listaPedido" class="lista-pedido"></ul>

    <div class="factura">
      <div class="linea">
        <span>Subtotal</span>
        <span id="subtotal">$0.00</span>
      </div>
      <div class="linea">
        <span>IVA (16%)</span>
        <span id="iva">$0.00</span>
      </div>
      <div class="linea total">
        <span>Total</span>
        <span id="total">$0.00</span>
      </div>
    </div>

    <!-- üß© Formulario normal -->
    <form method="post" action="{% url 'crear_pedido' %}" id="formPedido">
      {% csrf_token %}
      <input type="hidden" name="mesa" id="mesaSeleccionada" required>
      <div id="inputsHidden"></div>
      <button type="submit" class="btn-confirmar" id="btnConfirmar" disabled>
        üíæ Confirmar Pedido
      </button>
    </form>
  </aside>
</section>

<script>
let mesaSeleccionada = null;
let pedido = {};
let total = 0;

function seleccionarMesa(el) {
  if (el.dataset.ocupada === "true") {
    alert("‚ö†Ô∏è Mesa ocupada.");
    return;
  }
  document.querySelectorAll(".mesa-card").forEach(m => m.classList.remove("seleccionada"));
  el.classList.add("seleccionada");

  mesaSeleccionada = el.dataset.id;
  document.getElementById("mesaSeleccionada").value = mesaSeleccionada;
  document.getElementById("mesaNumero").innerText = el.querySelector(".numero").textContent;
  validarBotonConfirmar();
}

function agregarPlato(id, nombre, precio) {
  if (!mesaSeleccionada) {
    alert("Selecciona una mesa primero.");
    return;
  }
  if (!pedido[id]) pedido[id] = { nombre, cantidad: 1, precio: parseFloat(precio) };
  else pedido[id].cantidad++;
  renderPedido();
}

function renderPedido() {
  const lista = document.getElementById("listaPedido");
  const inputs = document.getElementById("inputsHidden");
  lista.innerHTML = "";
  inputs.innerHTML = "";
  let subtotal = 0;

  Object.entries(pedido).forEach(([id, item]) => {
    const sub = item.precio * item.cantidad;
    subtotal += sub;

    lista.innerHTML += `
      <li>
        <div>
          <strong>${item.nombre}</strong><br>
          <small>$${item.precio.toFixed(2)} c/u</small>
        </div>
        <div class="controles">
          <button type="button" onclick="cambiarCantidad('${id}', -1)">-</button>
          <span>${item.cantidad}</span>
          <button type="button" onclick="cambiarCantidad('${id}', 1)">+</button>
        </div>
        <div class="subtotal">$${sub.toFixed(2)}</div>
      </li>
    `;

    // üëâ Genera los inputs para el POST tradicional
    inputs.innerHTML += `
      <input type="hidden" name="platos" value="${id}">
      <input type="hidden" name="cantidades" value="${item.cantidad}">
    `;
  });

  const iva = subtotal * 0.16;
  total = subtotal + iva;

  document.getElementById("subtotal").textContent = "$" + subtotal.toFixed(2);
  document.getElementById("iva").textContent = "$" + iva.toFixed(2);
  document.getElementById("total").textContent = "$" + total.toFixed(2);
  validarBotonConfirmar();
}

function cambiarCantidad(id, delta) {
  pedido[id].cantidad += delta;
  if (pedido[id].cantidad <= 0) delete pedido[id];
  renderPedido();
}

function validarBotonConfirmar() {
  const btn = document.getElementById("btnConfirmar");
  btn.disabled = !(mesaSeleccionada && Object.keys(pedido).length > 0);
}
</script>
{% endblock %}
