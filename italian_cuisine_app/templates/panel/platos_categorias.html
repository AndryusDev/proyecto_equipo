{% extends 'panel_base.html' %}
{% load static %}
{% block titulo %}Platos y Categor√≠as{% endblock %}

{% block contenido %}
<link rel="stylesheet" href="{% static 'css/platos_categorias.css' %}">

<section class="panel">
  <div class="panel-header">
    <h2>üçù Platos y Categor√≠as</h2>
    <div class="acciones">
      <button class="btn-primario" onclick="abrirModal('modalCategoria')">+ Nueva Categor√≠a</button>
      <button class="btn-secundario" onclick="abrirModal('modalPlato')">+ Nuevo Plato</button>
    </div>
  </div>

  {% if messages %}
    <div class="mensajes">
      {% for message in messages %}
        <p class="mensaje {{ message.tags }}">{{ message }}</p>
      {% endfor %}
    </div>
  {% endif %}

  <div class="categorias">
    {% for categoria in categorias %}
      <div class="categoria-card">
        <div class="categoria-header">
          <div>
            <h3>{{ categoria.nombre }}</h3>
            <p>{{ categoria.platos.count }} platos</p>
          </div>

          <!-- ELIMINAR CATEGOR√çA -->
          <form method="post" action="{% url 'eliminar_categoria' categoria.id %}" onsubmit="return confirm('¬øEliminar la categor√≠a {{ categoria.nombre }}?');">
            {% csrf_token %}
            <button type="submit" class="btn-delete" title="Eliminar categor√≠a">
              <span>üóëÔ∏è</span>
            </button>
          </form>
        </div>

        <div class="platos">
          {% for plato in categoria.platos.all %}
            <div class="plato-card">
              {% if plato.imagen %}
                <img src="{{ plato.imagen.url }}" alt="{{ plato.nombre }}" loading="lazy">
              {% else %}
                <img src="{% static 'img/plato_default.jpg' %}" alt="Sin imagen" loading="lazy">
              {% endif %}

              <div class="plato-info">
                <h4>{{ plato.nombre }}</h4>
                <p class="descripcion">{{ plato.descripcion|default:"Sin descripci√≥n" }}</p>
                <p class="precio">${{ plato.precio }}</p>
                <span class="estado {% if plato.disponible %}disponible{% else %}no-disponible{% endif %}">
                  {% if plato.disponible %}Disponible{% else %}No disponible{% endif %}
                </span>
              </div>

              <div class="acciones-mini">
                <!-- EDITAR PLATO -->
                <button type="button" class="btn-edit-mini" title="Editar plato" onclick="abrirModalEditar('{{ plato.id }}')">‚úèÔ∏è</button>

                <!-- ELIMINAR PLATO -->
                <form method="post" action="{% url 'eliminar_plato' plato.id %}" onsubmit="return confirm('¬øEliminar el plato {{ plato.nombre }}?');">
                  {% csrf_token %}
                  <button type="submit" class="btn-delete-mini" title="Eliminar plato">
                    <span>üóëÔ∏è</span>
                  </button>
                </form>
              </div>
            </div>
          {% empty %}
            <p class="sin-platos">No hay platos en esta categor√≠a.</p>
          {% endfor %}
        </div>
      </div>
    {% empty %}
      <p class="sin-categorias">A√∫n no hay categor√≠as creadas.</p>
    {% endfor %}
  </div>
</section>

<!-- MODAL: NUEVA CATEGOR√çA -->
<div id="modalCategoria" class="modal">
  <div class="modal-content">
    <h3>üÜï Nueva Categor√≠a</h3>
    <form method="post" action="{% url 'agregar_categoria' %}">
      {% csrf_token %}
      <input type="text" name="nombre" placeholder="Nombre de la categor√≠a" required>
      <div class="modal-actions">
        <button type="submit" class="btn-guardar">Guardar</button>
        <button type="button" class="btn-cerrar" onclick="cerrarModal('modalCategoria')">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: NUEVO PLATO -->
<div id="modalPlato" class="modal">
  <div class="modal-content">
    <h3>üçù Nuevo Plato</h3>
    <form method="post" enctype="multipart/form-data" action="{% url 'agregar_plato' %}">
      {% csrf_token %}
      <input type="text" name="nombre" placeholder="Nombre del plato" required>
      <textarea name="descripcion" placeholder="Descripci√≥n"></textarea>
      <input type="number" name="precio" step="0.01" placeholder="Precio" required>
      
      <select name="categoria" required>
        <option value="">Seleccione categor√≠a</option>
        {% for categoria in categorias %}
          <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
        {% endfor %}
      </select>

      <label class="checkbox">
        <input type="checkbox" name="disponible" checked> Disponible
      </label>

      <input type="file" name="imagen" accept="image/*">

      <div class="modal-actions">
        <button type="submit" class="btn-guardar">Guardar Plato</button>
        <button type="button" class="btn-cerrar" onclick="cerrarModal('modalPlato')">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: EDITAR PLATO -->
<div id="modalEditarPlato" class="modal">
  <div class="modal-content">
    <h3>‚úèÔ∏è Editar Plato</h3>
    <form id="formEditarPlato" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="plato_id" id="plato_id">

      <input type="text" name="nombre" id="nombreEditar" placeholder="Nombre del plato" required>
      <textarea name="descripcion" id="descripcionEditar" placeholder="Descripci√≥n"></textarea>
      <input type="number" name="precio" id="precioEditar" step="0.01" placeholder="Precio" required>

      <label class="checkbox">
        <input type="checkbox" name="disponible" id="disponibleEditar"> Disponible
      </label>

      <select name="categoria" id="categoriaEditar" required>
        <option value="">Seleccione categor√≠a</option>
        {% for categoria in categorias %}
          <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
        {% endfor %}
      </select>

      <input type="file" name="imagen" accept="image/*">

      <div class="modal-actions">
        <button type="submit" class="btn-guardar">Guardar Cambios</button>
        <button type="button" class="btn-cerrar" onclick="cerrarModal('modalEditarPlato')">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<script>
  function abrirModal(id) {
    document.getElementById(id).style.display = 'flex';
  }
  function cerrarModal(id) {
    document.getElementById(id).style.display = 'none';
  }

  function abrirModalEditar(platoId) {
    fetch(`/plato/${platoId}/`)
      .then(response => response.json())
      .then(data => {
        document.getElementById('plato_id').value = data.id;
        document.getElementById('nombreEditar').value = data.nombre;
        document.getElementById('descripcionEditar').value = data.descripcion || '';
        document.getElementById('precioEditar').value = data.precio;
        document.getElementById('categoriaEditar').value = data.categoria;
        document.getElementById('disponibleEditar').checked = data.disponible;
        document.getElementById('modalEditarPlato').style.display = 'flex';
      })
      .catch(() => alert('Error al cargar el plato.'));
  }

  document.getElementById('formEditarPlato').addEventListener('submit', function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch(`/plato/editar/`, {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    }).then(response => {
      if (response.ok) {
        location.reload();
      } else {
        alert('Error al actualizar el plato.');
      }
    });
  });
</script>
{% endblock %}
