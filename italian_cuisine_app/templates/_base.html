<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Italian Cuisine{% endblock %}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'italian_cuisine_app/css/styles.css' %}">
</head>
<body>
    <div class="container">
        {% block content %}{% endblock %}
    </div>

    <!-- Toast container -->
    <div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <!-- Modal root (global) -->
    <div id="modal-root" class="modal-root" aria-hidden="true">
        <div class="modal-backdrop" data-modal-close></div>
        <div class="modal-window" role="dialog" aria-modal="true">
            <button class="modal-close" aria-label="Cerrar" data-modal-close>&times;</button>
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>

    <script>
    (function(){
        // Helpers
        function openModal(){
            const root = document.getElementById('modal-root');
            if(!root) return;
            root.setAttribute('aria-hidden','false');
            document.body.style.overflow = 'hidden';
        }
        function closeModal(){
            const root = document.getElementById('modal-root');
            if(!root) return;
            root.setAttribute('aria-hidden','true');
            const body = document.getElementById('modal-body'); if(body) body.innerHTML = '';
            document.body.style.overflow = '';
        }

        function getCookie(name){
            let cookieValue = null;
            if (document.cookie && document.cookie !== ''){
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++){
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')){
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Toast helper
        function showToast(message, type='success', timeout=3500){
            const container = document.getElementById('toast-container');
            if(!container) return;
            const t = document.createElement('div');
            t.className = 'toast ' + (type? type: '');
            t.textContent = message;
            container.appendChild(t);
            // Force reflow then show
            requestAnimationFrame(() => t.classList.add('show'));
            setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=> t.remove(), 220); }, timeout);
        }

        // Attach form submit inside modal to use fetch
        function attachModalFormHandler(){
            const modal = document.getElementById('modal-body');
            if(!modal) return;
            const form = modal.querySelector('form');
            if(!form) return;

            form.addEventListener('submit', function(e){
                e.preventDefault();
                const action = form.action || window.location.href;
                const method = (form.method || 'post').toUpperCase();
                const data = new FormData(form);
                const headers = {'X-Requested-With': 'XMLHttpRequest'};
                const csrftoken = getCookie('csrftoken'); if(csrftoken) headers['X-CSRFToken'] = csrftoken;

                fetch(action, {method: method, headers: headers, body: data})
                .then(response => {
                    const contentType = response.headers.get('content-type') || '';
                    if(contentType.indexOf('application/json') !== -1){
                        return response.json().then(json => ({json: json}));
                    }
                    return response.text().then(text => ({text: text, status: response.status}));
                })
                .then(result => handleAjaxResult(result))
                .catch(err => { console.error('Error enviando formulario en modal', err); showToast('Error de red', 'error'); });
            }, {once:true});
        }

        // Handle AJAX result from server (JSON or HTML)
        function handleAjaxResult(result){
            if(result.json){
                if(result.json.success){
                    if(result.json.action){
                        // pagination-aware table update logic
                        const action = result.json.action; const pk = result.json.pk; const html = result.json.html || '';
                        const table = document.querySelector('table.db-table');
                        const tbody = table ? table.querySelector('tbody') : null;
                        const perPage = table ? parseInt(table.dataset.perPage || '10',10) : 10;
                        const currentPage = table ? parseInt(table.dataset.currentPage || '1',10) : 1;

                        function renumberRows(){ if(!tbody) return; Array.from(tbody.querySelectorAll('tr')).forEach((tr,i)=>{ const first = tr.querySelector('td'); if(first) first.textContent = (i+1).toString(); }); }

                        if(!tbody){ closeModal(); window.location.reload(); return; }

                        if(action === 'create'){
                            if(currentPage === 1){ tbody.insertAdjacentHTML('afterbegin', html); while(tbody.children.length > perPage) tbody.removeChild(tbody.lastElementChild); renumberRows(); const newRow = tbody.querySelector('tr[data-pk="'+pk+'"]'); if(newRow){ newRow.classList.add('row-animate','row-inserted'); setTimeout(()=> newRow.classList.remove('row-inserted'),900);} showToast('Empleado creado correctamente.'); closeModal(); return; }
                            else { const url = new URL(window.location.href); url.searchParams.set('page','1'); window.location.href = url.toString(); return; }
                        }

                        if(action === 'update'){
                            const existing = document.querySelector('table.db-table tbody tr[data-pk="'+pk+'"]');
                            if(existing){ existing.outerHTML = html; const replaced = document.querySelector('table.db-table tbody tr[data-pk="'+pk+'"]'); if(replaced){ replaced.classList.add('row-animate','row-updated'); setTimeout(()=> replaced.classList.remove('row-updated'),900); } renumberRows(); showToast('Empleado actualizado correctamente.'); closeModal(); return; }
                            else if(currentPage === 1){ tbody.insertAdjacentHTML('afterbegin', html); while(tbody.children.length > perPage) tbody.removeChild(tbody.lastElementChild); renumberRows(); showToast('Empleado actualizado y aÃ±adido a la lista.'); closeModal(); return; }
                            else { closeModal(); window.location.reload(); return; }
                        }

                        if(action === 'delete'){
                            const existing = document.querySelector('table.db-table tbody tr[data-pk="'+pk+'"]'); if(existing){ existing.remove(); showToast('Empleado eliminado.'); }
                            if((tbody.children.length === 0) && currentPage > 1){ const url = new URL(window.location.href); url.searchParams.set('page', String(currentPage-1)); window.location.href = url.toString(); return; }
                            renumberRows(); closeModal(); return;
                        }
                    }
                    // fallback reload
                    closeModal(); window.location.reload(); return;
                } else if(result.json.html){ document.getElementById('modal-body').innerHTML = result.json.html; attachModalFormHandler(); return; }
            } else if(result.text){ if(result.status && result.status >= 400){ document.getElementById('modal-body').innerHTML = result.text; attachModalFormHandler(); return; } else { closeModal(); window.location.reload(); return; } }
        }

        // Delegate click to open modal for links with data-modal
        document.addEventListener('click', function(e){ const el = e.target.closest('[data-modal="true"]'); if(!el) return; e.preventDefault(); const url = el.getAttribute('href'); fetch(url, {headers: {'X-Requested-With': 'XMLHttpRequest'}}).then(r => r.text()).then(html => { document.getElementById('modal-body').innerHTML = html; openModal(); attachModalFormHandler(); }).catch(err => { console.error(err); showToast('Error cargando contenido', 'error'); }); });

        // Close on backdrop or close buttons
        document.addEventListener('click', function(e){ const el = e.target.closest('[data-modal-close]'); if(!el) return; e.preventDefault(); closeModal(); });

    })();
    </script>
</body>
</html>